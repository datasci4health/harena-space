/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/rete@1.4.3-rc.1/build/rete.common.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";function asyncGeneratorStep(e,t,n,r,o,i,s){try{var a=e[i](s),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function s(e){asyncGeneratorStep(i,r,o,s,a,"next",e)}function a(e){asyncGeneratorStep(i,r,o,s,a,"throw",e)}s(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _get(e,t,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=_superPropBase(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _iterableToArrayLimit(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return n}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}Object.defineProperty(exports,"__esModule",{value:!0});var Component=function e(t){_classCallCheck(this,e),_defineProperty(this,"name",void 0),_defineProperty(this,"data",{}),_defineProperty(this,"engine",null),this.name=t},Node=function(){function e(t){_classCallCheck(this,e),_defineProperty(this,"name",void 0),_defineProperty(this,"id",void 0),_defineProperty(this,"position",[0,0]),_defineProperty(this,"inputs",new Map),_defineProperty(this,"outputs",new Map),_defineProperty(this,"controls",new Map),_defineProperty(this,"data",{}),_defineProperty(this,"meta",{}),this.name=t,this.id=e.incrementId()}return _createClass(e,[{key:"_add",value:function(e,t,n){if(e.has(t.key))throw new Error("Item with key '".concat(t.key,"' already been added to the node"));if(null!==t[n])throw new Error("Item has already been added to some node");t[n]=this,e.set(t.key,t)}},{key:"addControl",value:function(e){return this._add(this.controls,e,"parent"),this}},{key:"removeControl",value:function(e){e.parent=null,this.controls.delete(e.key)}},{key:"addInput",value:function(e){return this._add(this.inputs,e,"node"),this}},{key:"removeInput",value:function(e){e.removeConnections(),e.node=null,this.inputs.delete(e.key)}},{key:"addOutput",value:function(e){return this._add(this.outputs,e,"node"),this}},{key:"removeOutput",value:function(e){e.removeConnections(),e.node=null,this.outputs.delete(e.key)}},{key:"getConnections",value:function(){return[].concat(_toConsumableArray(this.inputs.values()),_toConsumableArray(this.outputs.values())).reduce(function(e,t){return[].concat(_toConsumableArray(e),_toConsumableArray(t.connections))},[])}},{key:"update",value:function(){}},{key:"toJSON",value:function(){var e=function(e){return Array.from(e).reduce(function(e,t){var n=_slicedToArray(t,2),r=n[0],o=n[1];return e[r]=o.toJSON(),e},{})};return{id:this.id,data:this.data,inputs:e(this.inputs),outputs:e(this.outputs),position:this.position,name:this.name}}}],[{key:"incrementId",value:function(){return this.latestId?this.latestId++:this.latestId=1,this.latestId}},{key:"resetId",value:function(){this.latestId=0}},{key:"fromJSON",value:function(t){var n=new e(t.name),r=_slicedToArray(t.position,2),o=r[0],i=r[1];return n.id=t.id,n.data=t.data,n.position=[o,i],n.name=t.name,e.latestId=Math.max(n.id,e.latestId),n}}]),e}();_defineProperty(Node,"latestId",0);var Component$1=function(e){function t(e){var n;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e))),"editor",null),_defineProperty(_assertThisInitialized(n),"data",{}),n}return _inherits(t,e),_createClass(t,[{key:"build",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.builder(t);case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"createNode",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},(n=new Node(this.name)).data=t,e.next=5,this.build(n);case 5:return e.abrupt("return",n);case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),t}(Component),Connection=function(){function e(t,n){_classCallCheck(this,e),_defineProperty(this,"output",void 0),_defineProperty(this,"input",void 0),_defineProperty(this,"data",{}),this.output=t,this.input=n,this.data={},this.input.addConnection(this)}return _createClass(e,[{key:"remove",value:function(){this.input.removeConnection(this),this.output.removeConnection(this)}}]),e}(),Control=function(){function e(t){if(_classCallCheck(this,e),_defineProperty(this,"key",void 0),_defineProperty(this,"data",{}),_defineProperty(this,"parent",null),this.constructor===e)throw new TypeError("Can not construct abstract class");if(!t)throw new Error("The key parameter is missing in super() of Control ");this.key=t}return _createClass(e,[{key:"getNode",value:function(){if(null===this.parent)throw new Error("Control isn't added to Node/Input");if(this.parent instanceof Node)return this.parent;if(!this.parent.node)throw new Error("Control hasn't be added to Input or Node");return this.parent.node}},{key:"getData",value:function(e){return this.getNode().data[e]}},{key:"putData",value:function(e,t){this.getNode().data[e]=t}}]),e}(),Emitter=function(){function e(t){_classCallCheck(this,e),_defineProperty(this,"events",{}),_defineProperty(this,"silent",!1),this.events=t instanceof e?t.events:t.handlers}return _createClass(e,[{key:"on",value:function(e,t){var n=this;return(e instanceof Array?e:e.split(" ")).forEach(function(e){if(!n.events[e])throw new Error("The event ".concat(e," does not exist"));n.events[e].push(t)}),this}},{key:"trigger",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!(e in this.events))throw new Error("The event ".concat(e," cannot be triggered"));return this.events[e].reduce(function(e,n){return!1!==n(t)&&e},!0)}},{key:"bind",value:function(e){if(this.events[e])throw new Error("The event ".concat(e," is already bound"));this.events[e]=[]}},{key:"exist",value:function(e){return Array.isArray(this.events[e])}}]),e}(),IO=function(){function e(t,n,r,o){_classCallCheck(this,e),_defineProperty(this,"node",null),_defineProperty(this,"multipleConnections",void 0),_defineProperty(this,"connections",[]),_defineProperty(this,"key",void 0),_defineProperty(this,"name",void 0),_defineProperty(this,"socket",void 0),this.node=null,this.multipleConnections=o,this.connections=[],this.key=t,this.name=n,this.socket=r}return _createClass(e,[{key:"removeConnection",value:function(e){this.connections.splice(this.connections.indexOf(e),1)}},{key:"removeConnections",value:function(){var e=this;this.connections.forEach(function(t){return e.removeConnection(t)})}}]),e}(),Input=function(e){function t(e,n,r){var o,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,n,r,i))),"control",null),o}return _inherits(t,IO),_createClass(t,[{key:"hasConnection",value:function(){return this.connections.length>0}},{key:"addConnection",value:function(e){if(!this.multipleConnections&&this.hasConnection())throw new Error("Multiple connections not allowed");this.connections.push(e)}},{key:"addControl",value:function(e){this.control=e,e.parent=this}},{key:"showControl",value:function(){return!this.hasConnection()&&null!==this.control}},{key:"toJSON",value:function(){return{connections:this.connections.map(function(e){if(!e.output.node)throw new Error("Node not added to Output");return{node:e.output.node.id,output:e.output.key,data:e.data}})}}}]),t}(),Validator=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"isValidData",value:function(e){return"string"==typeof e.id&&this.isValidId(e.id)&&e.nodes instanceof Object&&!(e.nodes instanceof Array)}},{key:"isValidId",value:function(e){return/^[\w-]{3,}@[0-9]+\.[0-9]+\.[0-9]+$/.test(e)}},{key:"validate",value:function(e,t){var n=e.split("@"),r=t.id.split("@"),o=[];return this.isValidData(t)||o.push("Data is not suitable"),e!==t.id&&o.push("IDs not equal"),n[0]!==r[0]&&o.push("Names don't match"),n[1]!==r[1]&&o.push("Versions don't match"),{success:Boolean(!o.length),msg:o.join(". ")}}}]),e}(),Context=function(e){function t(e,n){var r;if(_classCallCheck(this,t),_defineProperty(_assertThisInitialized(r=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,n))),"id",void 0),_defineProperty(_assertThisInitialized(r),"plugins",void 0),_defineProperty(_assertThisInitialized(r),"components",void 0),!Validator.isValidId(e))throw new Error("ID should be valid to name@0.1.0 format");return r.id=e,r.plugins=new Map,r.components=new Map,r}return _inherits(t,Emitter),_createClass(t,[{key:"use",value:function(e,t){if(e.name&&this.plugins.has(e.name))throw new Error("Plugin ".concat(e.name," already in use"));e.install(this,t||{}),this.plugins.set(e.name,t)}},{key:"register",value:function(e){if(this.components.has(e.name))throw new Error("Component ".concat(e.name," already registered"));this.components.set(e.name,e),this.trigger("componentregister",e)}},{key:"destroy",value:function(){this.trigger("destroy")}}]),t}();function listenWindow(e,t){return window.addEventListener(e,t),function(){window.removeEventListener(e,t)}}var Drag=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e,t,n){},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(e){};_classCallCheck(this,e),this.onTranslate=n,this.onStart=r,this.onDrag=o,_defineProperty(this,"pointerStart",void 0),_defineProperty(this,"el",void 0),_defineProperty(this,"destroy",void 0),this.pointerStart=null,this.el=t,this.el.style.touchAction="none",this.el.addEventListener("pointerdown",this.down.bind(this));var i=listenWindow("pointermove",this.move.bind(this)),s=listenWindow("pointerup",this.up.bind(this));this.destroy=function(){i(),s()}}return _createClass(e,[{key:"down",value:function(e){"mouse"===e.pointerType&&0!==e.button||(e.stopPropagation(),this.pointerStart=[e.pageX,e.pageY],this.onStart(e))}},{key:"move",value:function(e){if(this.pointerStart){e.preventDefault();var t=[e.pageX,e.pageY],n=t[1],r=[t[0]-this.pointerStart[0],n-this.pointerStart[1]],o=this.el.getBoundingClientRect().width/this.el.offsetWidth;this.onTranslate(r[0]/o,r[1]/o,e)}}},{key:"up",value:function(e){this.pointerStart&&(this.pointerStart=null,this.onDrag(e))}}]),e}(),Zoom=function(){function e(t,n,r,o){_classCallCheck(this,e),_defineProperty(this,"el",void 0),_defineProperty(this,"intensity",void 0),_defineProperty(this,"onzoom",void 0),_defineProperty(this,"previous",null),_defineProperty(this,"pointers",[]),_defineProperty(this,"destroy",void 0),this.el=n,this.intensity=r,this.onzoom=o,t.addEventListener("wheel",this.wheel.bind(this)),t.addEventListener("pointerdown",this.down.bind(this)),t.addEventListener("dblclick",this.dblclick.bind(this));var i=listenWindow("pointermove",this.move.bind(this)),s=listenWindow("pointerup",this.end.bind(this)),a=listenWindow("pointercancel",this.end.bind(this));this.destroy=function(){i(),s(),a()}}return _createClass(e,[{key:"wheel",value:function(e){e.preventDefault();var t=this.el.getBoundingClientRect(),n=e.wheelDelta,r=(n?n/120:-e.deltaY/3)*this.intensity,o=(t.left-e.clientX)*r,i=(t.top-e.clientY)*r;this.onzoom(r,o,i,"wheel")}},{key:"touches",value:function(){var e={touches:this.pointers},t=[e.touches[0].clientX,e.touches[0].clientY],n=t[0],r=t[1],o=[e.touches[1].clientX,e.touches[1].clientY],i=o[0],s=o[1];return{cx:(n+i)/2,cy:(r+s)/2,distance:Math.sqrt(Math.pow(n-i,2)+Math.pow(r-s,2))}}},{key:"down",value:function(e){this.pointers.push(e)}},{key:"move",value:function(e){if(this.pointers=this.pointers.map(function(t){return t.pointerId===e.pointerId?e:t}),this.translating){var t=this.el.getBoundingClientRect(),n=this.touches(),r=n.cx,o=n.cy,i=n.distance;if(null!==this.previous){var s=i/this.previous.distance-1,a=(t.left-r)*s,u=(t.top-o)*s;this.onzoom(s,a-(this.previous.cx-r),u-(this.previous.cy-o),"touch")}this.previous={cx:r,cy:o,distance:i}}}},{key:"end",value:function(e){this.previous=null,this.pointers=this.pointers.filter(function(t){return t.pointerId!==e.pointerId})}},{key:"dblclick",value:function(e){e.preventDefault();var t=this.el.getBoundingClientRect(),n=4*this.intensity,r=(t.left-e.clientX)*n,o=(t.top-e.clientY)*n;this.onzoom(n,r,o,"dblclick")}},{key:"translating",get:function(){return this.pointers.length>=2}}]),e}(),Area=function(e){function t(e,n){var r;_classCallCheck(this,t),_defineProperty(_assertThisInitialized(r=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,n))),"el",void 0),_defineProperty(_assertThisInitialized(r),"container",void 0),_defineProperty(_assertThisInitialized(r),"transform",{k:1,x:0,y:0}),_defineProperty(_assertThisInitialized(r),"mouse",{x:0,y:0}),_defineProperty(_assertThisInitialized(r),"_startPosition",null),_defineProperty(_assertThisInitialized(r),"_zoom",void 0),_defineProperty(_assertThisInitialized(r),"_drag",void 0);var o=r.el=document.createElement("div");return r.container=e,o.style.transformOrigin="0 0",r._zoom=new Zoom(e,o,.1,r.onZoom.bind(_assertThisInitialized(r))),r._drag=new Drag(e,r.onTranslate.bind(_assertThisInitialized(r)),r.onStart.bind(_assertThisInitialized(r))),n.on("destroy",function(){r._zoom.destroy(),r._drag.destroy()}),r.container.addEventListener("pointermove",r.pointermove.bind(_assertThisInitialized(r))),r.update(),r}return _inherits(t,Emitter),_createClass(t,[{key:"update",value:function(){var e=this.transform;this.el.style.transform="translate(".concat(e.x,"px, ").concat(e.y,"px) scale(").concat(e.k,")")}},{key:"pointermove",value:function(e){var t=e.clientX,n=e.clientY,r=this.el.getBoundingClientRect(),o=t-r.left,i=n-r.top,s=this.transform.k;this.mouse={x:o/s,y:i/s},this.trigger("mousemove",_objectSpread({},this.mouse))}},{key:"onStart",value:function(){this._startPosition=_objectSpread({},this.transform)}},{key:"onTranslate",value:function(e,t){this._zoom.translating||this._startPosition&&this.translate(this._startPosition.x+e,this._startPosition.y+t)}},{key:"onZoom",value:function(e,t,n,r){this.zoom(this.transform.k*(1+e),t,n,r),this.update()}},{key:"translate",value:function(e,t){var n={transform:this.transform,x:e,y:t};this.trigger("translate",n)&&(this.transform.x=n.x,this.transform.y=n.y,this.update(),this.trigger("translated"))}},{key:"zoom",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3?arguments[3]:void 0,o=this.transform.k,i={transform:this.transform,zoom:e,source:r};if(this.trigger("zoom",i)){var s=(o-i.zoom)/(o-e||1);this.transform.k=i.zoom||1,this.transform.x+=t*s,this.transform.y+=n*s,this.update(),this.trigger("zoomed",{source:r})}}},{key:"appendChild",value:function(e){this.el.appendChild(e)}},{key:"removeChild",value:function(e){this.el.removeChild(e)}}]),t}(),ConnectionView=function(e){function t(e,n,r,o){var i;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(i=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,o))),"connection",void 0),_defineProperty(_assertThisInitialized(i),"inputNode",void 0),_defineProperty(_assertThisInitialized(i),"outputNode",void 0),_defineProperty(_assertThisInitialized(i),"el",void 0),i.connection=e,i.inputNode=n,i.outputNode=r,i.el=document.createElement("div"),i.el.style.position="absolute",i.el.style.zIndex="-1",i.trigger("renderconnection",{el:i.el,connection:i.connection,points:i.getPoints()}),i}return _inherits(t,Emitter),_createClass(t,[{key:"getPoints",value:function(){var e=_slicedToArray(this.outputNode.getSocketPosition(this.connection.output),2),t=e[0],n=e[1],r=_slicedToArray(this.inputNode.getSocketPosition(this.connection.input),2);return[t,n,r[0],r[1]]}},{key:"update",value:function(){this.trigger("updateconnection",{el:this.el,connection:this.connection,points:this.getPoints()})}}]),t}(),ControlView=function(e){function t(e,n,r){var o;return _classCallCheck(this,t),(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,r))).trigger("rendercontrol",{el:e,control:n}),o}return _inherits(t,Emitter),t}(),SocketView=function(e){function t(e,n,r,o,i){var s,a;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(a=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,i))),"el",void 0),_defineProperty(_assertThisInitialized(a),"type",void 0),_defineProperty(_assertThisInitialized(a),"io",void 0),_defineProperty(_assertThisInitialized(a),"node",void 0),a.el=e,a.type=n,a.io=r,a.node=o,a.trigger("rendersocket",(_defineProperty(s={el:e},n,a.io),_defineProperty(s,"socket",r.socket),s)),a}return _inherits(t,Emitter),_createClass(t,[{key:"getPosition",value:function(e){var t=e.position,n=this.el;return[t[0]+n.offsetLeft+n.offsetWidth/2,t[1]+n.offsetTop+n.offsetHeight/2]}}]),t}(),NodeView=function(e){function t(e,n,r){var o;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,r))),"node",void 0),_defineProperty(_assertThisInitialized(o),"component",void 0),_defineProperty(_assertThisInitialized(o),"sockets",new Map),_defineProperty(_assertThisInitialized(o),"controls",new Map),_defineProperty(_assertThisInitialized(o),"el",void 0),_defineProperty(_assertThisInitialized(o),"_startPosition",[]),_defineProperty(_assertThisInitialized(o),"_drag",void 0),o.node=e,o.component=n,o.el=document.createElement("div"),o.el.style.position="absolute",o.el.addEventListener("contextmenu",function(e){return o.trigger("contextmenu",{e:e,node:o.node})}),o._drag=new Drag(o.el,o.onTranslate.bind(_assertThisInitialized(o)),o.onSelect.bind(_assertThisInitialized(o)),function(){o.trigger("nodedraged",e)}),o.trigger("rendernode",{el:o.el,node:e,component:n.data,bindSocket:o.bindSocket.bind(_assertThisInitialized(o)),bindControl:o.bindControl.bind(_assertThisInitialized(o))}),o.update(),o}return _inherits(t,Emitter),_createClass(t,[{key:"clearSockets",value:function(){var e=this,t=[].concat(_toConsumableArray(this.node.inputs.values()),_toConsumableArray(this.node.outputs.values()));this.sockets.forEach(function(n){t.includes(n.io)||e.sockets.delete(n.io)})}},{key:"bindSocket",value:function(e,t,n){this.clearSockets(),this.sockets.set(n,new SocketView(e,t,n,this.node,this))}},{key:"bindControl",value:function(e,t){this.controls.set(t,new ControlView(e,t,this))}},{key:"getSocketPosition",value:function(e){var t=this.sockets.get(e);if(!t)throw new Error("Socket not fount for ".concat(e.name," with key ").concat(e.key));return t.getPosition(this.node)}},{key:"onSelect",value:function(e){var t={node:this.node,accumulate:e.ctrlKey,e:e};this.onStart(),this.trigger("multiselectnode",t),this.trigger("selectnode",t)}},{key:"onStart",value:function(){this._startPosition=_toConsumableArray(this.node.position)}},{key:"onTranslate",value:function(e,t){this.trigger("translatenode",{node:this.node,dx:e,dy:t})}},{key:"onDrag",value:function(e,t){var n=this._startPosition[0]+e,r=this._startPosition[1]+t;this.translate(n,r)}},{key:"translate",value:function(e,t){var n=this.node,r={node:n,x:e,y:t};if(this.trigger("nodetranslate",r)){var o=_slicedToArray(n.position,2),i=[o[0],o[1]];n.position[0]=r.x,n.position[1]=r.y,this.update(),this.trigger("nodetranslated",{node:n,prev:i})}}},{key:"update",value:function(){var e=_slicedToArray(this.node.position,2),t=e[0],n=e[1];this.el.style.transform="translate(".concat(t,"px, ").concat(n,"px)")}},{key:"remove",value:function(){}},{key:"destroy",value:function(){this._drag.destroy()}}]),t}(),EditorView=function(e){function t(e,n,r){var o;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,r))),"container",void 0),_defineProperty(_assertThisInitialized(o),"components",void 0),_defineProperty(_assertThisInitialized(o),"nodes",new Map),_defineProperty(_assertThisInitialized(o),"connections",new Map),_defineProperty(_assertThisInitialized(o),"area",void 0),o.container=e,o.components=n,o.container.style.overflow="hidden",o.container.addEventListener("click",o.click.bind(_assertThisInitialized(o))),o.container.addEventListener("contextmenu",function(e){return o.trigger("contextmenu",{e:e,view:_assertThisInitialized(o)})}),r.on("destroy",listenWindow("resize",o.resize.bind(_assertThisInitialized(o)))),r.on("destroy",function(){return o.nodes.forEach(function(e){return e.destroy()})}),o.on("nodetranslated",o.updateConnections.bind(_assertThisInitialized(o))),o.area=new Area(e,_assertThisInitialized(o)),o.container.appendChild(o.area.el),o}return _inherits(t,Emitter),_createClass(t,[{key:"addNode",value:function(e){var t=this.components.get(e.name);if(!t)throw new Error("Component ".concat(e.name," not found"));var n=new NodeView(e,t,this);this.nodes.set(e,n),this.area.appendChild(n.el)}},{key:"removeNode",value:function(e){var t=this.nodes.get(e);this.nodes.delete(e),t&&(this.area.removeChild(t.el),t.destroy())}},{key:"addConnection",value:function(e){if(!e.input.node||!e.output.node)throw new Error("Connection input or output not added to node");var t=this.nodes.get(e.input.node),n=this.nodes.get(e.output.node);if(!t||!n)throw new Error("View node not fount for input or output");var r=new ConnectionView(e,t,n,this);this.connections.set(e,r),this.area.appendChild(r.el)}},{key:"removeConnection",value:function(e){var t=this.connections.get(e);this.connections.delete(e),t&&this.area.removeChild(t.el)}},{key:"updateConnections",value:function(e){var t=this;e.node.getConnections().forEach(function(e){var n=t.connections.get(e);if(!n)throw new Error("Connection view not found");n.update()})}},{key:"resize",value:function(){var e=this.container;if(!e.parentElement)throw new Error("Container doesn't have parent element");var t=e.parentElement.clientWidth,n=e.parentElement.clientHeight;e.style.width=t+"px",e.style.height=n+"px"}},{key:"click",value:function(e){var t=this.container;t===e.target&&this.trigger("click",{e:e,container:t})}}]),t}(),Selected=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"list",[])}return _createClass(e,[{key:"add",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?this.contains(e)||this.list.push(e):this.list=[e]}},{key:"clear",value:function(){this.list=[]}},{key:"remove",value:function(e){this.list.splice(this.list.indexOf(e),1)}},{key:"contains",value:function(e){return-1!==this.list.indexOf(e)}},{key:"each",value:function(e){this.list.forEach(e)}}]),e}(),Events=function e(t){_classCallCheck(this,e),_defineProperty(this,"handlers",void 0),this.handlers=_objectSpread({warn:[console.warn],error:[console.error],componentregister:[],destroy:[]},t)},EditorEvents=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,{nodecreate:[],nodecreated:[],noderemove:[],noderemoved:[],connectioncreate:[],connectioncreated:[],connectionremove:[],connectionremoved:[],translatenode:[],nodetranslate:[],nodetranslated:[],nodedraged:[],selectnode:[],multiselectnode:[],nodeselect:[],nodeselected:[],rendernode:[],rendersocket:[],rendercontrol:[],renderconnection:[],updateconnection:[],keydown:[],keyup:[],translate:[],translated:[],zoom:[],zoomed:[],click:[],mousemove:[],contextmenu:[],import:[],export:[],process:[],clear:[]}))}return _inherits(t,Events),t}(),NodeEditor=function(e){function t(e,n){var r;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(r=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,new EditorEvents))),"nodes",[]),_defineProperty(_assertThisInitialized(r),"selected",new Selected),_defineProperty(_assertThisInitialized(r),"view",void 0),r.view=new EditorView(n,r.components,_assertThisInitialized(r)),r.on("destroy",listenWindow("keydown",function(e){return r.trigger("keydown",e)})),r.on("destroy",listenWindow("keyup",function(e){return r.trigger("keyup",e)})),r.on("selectnode",function(e){var t=e.node,n=e.accumulate;return r.selectNode(t,n)}),r.on("nodeselected",function(){return r.selected.each(function(e){var t=r.view.nodes.get(e);t&&t.onStart()})}),r.on("translatenode",function(e){var t=e.dx,n=e.dy;return r.selected.each(function(e){var o=r.view.nodes.get(e);o&&o.onDrag(t,n)})}),r}return _inherits(t,Context),_createClass(t,[{key:"addNode",value:function(e){this.trigger("nodecreate",e)&&(this.nodes.push(e),this.view.addNode(e),this.trigger("nodecreated",e))}},{key:"removeNode",value:function(e){var t=this;this.trigger("noderemove",e)&&(e.getConnections().forEach(function(e){return t.removeConnection(e)}),this.nodes.splice(this.nodes.indexOf(e),1),this.view.removeNode(e),this.trigger("noderemoved",e))}},{key:"connect",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.trigger("connectioncreate",{output:e,input:t}))try{var r=e.connectTo(t);r.data=n,this.view.addConnection(r),this.trigger("connectioncreated",r)}catch(e){this.trigger("warn",e)}}},{key:"removeConnection",value:function(e){this.trigger("connectionremove",e)&&(this.view.removeConnection(e),e.remove(),this.trigger("connectionremoved",e))}},{key:"selectNode",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(-1===this.nodes.indexOf(e))throw new Error("Node not exist in list");this.trigger("nodeselect",e)&&(this.selected.add(e,t),this.trigger("nodeselected",e))}},{key:"getComponent",value:function(e){var t=this.components.get(e);if(!t)throw"Component ".concat(e," not found");return t}},{key:"register",value:function(e){_get(_getPrototypeOf(t.prototype),"register",this).call(this,e),e.editor=this}},{key:"clear",value:function(){var e=this;_toConsumableArray(this.nodes).forEach(function(t){return e.removeNode(t)}),this.trigger("clear")}},{key:"toJSON",value:function(){var e={id:this.id,nodes:{}};return this.nodes.forEach(function(t){return e.nodes[t.id]=t.toJSON()}),this.trigger("export",e),e}},{key:"beforeImport",value:function(e){var t=Validator.validate(this.id,e);return t.success?(this.silent=!0,this.clear(),this.trigger("import",e),!0):(this.trigger("warn",t.msg),!1)}},{key:"afterImport",value:function(){return this.silent=!1,!0}},{key:"fromJSON",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.beforeImport(t)){e.next=2;break}return e.abrupt("return",!1);case 2:return n={},e.prev=3,e.next=6,Promise.all(Object.keys(t.nodes).map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(o){var i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.nodes[o],s=r.getComponent(i.name),e.next=4,s.build(Node.fromJSON(i));case 4:n[o]=e.sent,r.addNode(n[o]);case 6:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 6:Object.keys(t.nodes).forEach(function(e){var o=t.nodes[e],i=n[e];Object.keys(o.outputs).forEach(function(e){o.outputs[e].connections.forEach(function(t){var o=t.node,s=t.data,a=i.outputs.get(e),u=n[o].inputs.get(t.input);if(!a||!u)return r.trigger("error","IO not found for node ".concat(i.id));r.connect(a,u,s)})})}),e.next=13;break;case 9:return e.prev=9,e.t0=e.catch(3),this.trigger("warn",e.t0),e.abrupt("return",!this.afterImport());case 13:return e.abrupt("return",this.afterImport());case 14:case"end":return e.stop()}},e,this,[[3,9]])}));return function(t){return e.apply(this,arguments)}}()}]),t}(),Output=function(e){function t(e,n,r){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,n,r,o))}return _inherits(t,IO),_createClass(t,[{key:"hasConnection",value:function(){return this.connections.length>0}},{key:"connectTo",value:function(e){if(!this.socket.compatibleWith(e.socket))throw new Error("Sockets not compatible");if(!e.multipleConnections&&e.hasConnection())throw new Error("Input already has one connection");if(!this.multipleConnections&&this.hasConnection())throw new Error("Output already has one connection");var t=new Connection(this,e);return this.connections.push(t),t}},{key:"connectedTo",value:function(e){return this.connections.some(function(t){return t.input===e})}},{key:"toJSON",value:function(){return{connections:this.connections.map(function(e){if(!e.input.node)throw new Error("Node not added to Input");return{node:e.input.node.id,input:e.input.key,data:e.data}})}}}]),t}(),Socket=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,e),_defineProperty(this,"name",void 0),_defineProperty(this,"data",void 0),_defineProperty(this,"compatible",[]),this.name=t,this.data=n,this.compatible=[]}return _createClass(e,[{key:"combineWith",value:function(e){this.compatible.push(e)}},{key:"compatibleWith",value:function(e){return this===e||this.compatible.includes(e)}}]),e}();function intersect(e,t){return e.filter(function(e){return-1!==t.indexOf(e)})}var Recursion=function(){function e(t){_classCallCheck(this,e),_defineProperty(this,"nodes",void 0),this.nodes=t}return _createClass(e,[{key:"extractInputNodes",value:function(e){var t=this;return Object.keys(e.inputs).reduce(function(n,r){var o=(e.inputs[r].connections||[]).reduce(function(e,n){return[].concat(_toConsumableArray(e),[t.nodes[n.node]])},[]);return[].concat(_toConsumableArray(n),_toConsumableArray(o))},[])}},{key:"findSelf",value:function(e,t){var n=intersect(e,t);if(n.length)return n[0];var r=!0,o=!1,i=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var u=s.value,c=[u].concat(_toConsumableArray(e)),l=this.findSelf(c,this.extractInputNodes(u));if(l)return l}}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return null}},{key:"detect",value:function(){var e=this,t=Object.keys(this.nodes).map(function(t){return e.nodes[t]}),n=!0,r=!1,o=void 0;try{for(var i,s=t[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var a=i.value,u=this.findSelf([a],this.extractInputNodes(a));if(u)return u}}catch(e){r=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}return null}}]),e}(),State={AVAILABLE:0,PROCESSED:1,ABORT:2},EngineEvents=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,{}))}return _inherits(t,Events),t}(),Engine=function(e){function t(e){var n;return _classCallCheck(this,t),_defineProperty(_assertThisInitialized(n=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this,e,new EngineEvents))),"args",[]),_defineProperty(_assertThisInitialized(n),"data",null),_defineProperty(_assertThisInitialized(n),"state",State.AVAILABLE),_defineProperty(_assertThisInitialized(n),"onAbort",function(){}),n}return _inherits(t,Context),_createClass(t,[{key:"clone",value:function(){var e=new t(this.id);return this.components.forEach(function(t){return e.register(t)}),e}},{key:"throwError",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:null,e.next=3,this.abort();case 3:return this.trigger("error",{message:t,data:n}),this.processDone(),e.abrupt("return","error");case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"processStart",value:function(){return this.state===State.AVAILABLE?(this.state=State.PROCESSED,!0):this.state!==State.ABORT&&(console.warn("The process is busy and has not been restarted.\n                Use abort() to force it to complete"),!1)}},{key:"processDone",value:function(){var e=this.state!==State.ABORT;return this.state=State.AVAILABLE,e||(this.onAbort(),this.onAbort=function(){}),e}},{key:"abort",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){t.state===State.PROCESSED?(t.state=State.ABORT,t.onAbort=e):t.state===State.ABORT?(t.onAbort(),t.onAbort=e):e()}));case 1:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}()},{key:"lock",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){t.unlockPool=t.unlockPool||[],t.busy&&!t.outputData?t.unlockPool.push(e):e(),t.busy=!0}));case 1:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()},{key:"unlock",value:function(e){e.unlockPool.forEach(function(e){return e()}),e.unlockPool=[],e.busy=!1}},{key:"extractInputData",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o,i,s,a,u,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n={},r=0,o=Object.keys(t.inputs);case 2:if(!(r<o.length)){e.next=13;break}return i=o[r],s=t.inputs[i],a=s.connections,e.next=8,Promise.all(a.map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.data.nodes[t.node],e.next=3,c.processNode(n);case 3:if(r=e.sent){e.next=8;break}c.abort(),e.next=9;break;case 8:return e.abrupt("return",r[t.output]);case 9:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 8:u=e.sent,n[i]=u;case 10:r++,e.next=2;break;case 13:return e.abrupt("return",n);case 14:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()},{key:"processWorker",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.extractInputData(t);case 2:return n=e.sent,r=this.components.get(t.name),o={},e.prev=5,e.next=8,r.worker.apply(r,[t,n,o].concat(_toConsumableArray(this.args)));case 8:e.next=14;break;case 10:e.prev=10,e.t0=e.catch(5),this.abort(),this.trigger("warn",e.t0);case 14:return e.abrupt("return",o);case 15:case"end":return e.stop()}},e,this,[[5,10]])}));return function(t){return e.apply(this,arguments)}}()},{key:"processNode",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state!==State.ABORT&&t){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this.lock(t);case 4:if(t.outputData){e.next=8;break}return e.next=7,this.processWorker(t);case 7:t.outputData=e.sent;case 8:return this.unlock(t),e.abrupt("return",t.outputData);case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"forwardProcess",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state!==State.ABORT){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,Promise.all(Object.keys(t.outputs).map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.outputs[r],e.next=3,Promise.all(o.connections.map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.data.nodes[t.node],e.next=3,n.processNode(r);case 3:return e.next=5,n.forwardProcess(r);case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"copy",value:function(e){return(e=Object.assign({},e)).nodes=Object.assign({},e.nodes),Object.keys(e.nodes).forEach(function(t){e.nodes[t]=Object.assign({},e.nodes[t])}),e}},{key:"validate",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Validator.validate(this.id,t),r=new Recursion(t.nodes),n.success){e.next=6;break}return e.next=5,this.throwError(n.msg);case 5:return e.abrupt("return",e.sent);case 6:if(!(o=r.detect())){e.next=11;break}return e.next=10,this.throwError("Recursion detected",o);case 10:return e.abrupt("return",e.sent);case 11:return e.abrupt("return",!0);case 12:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"processStartNode",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:if(n=this.data.nodes[t]){e.next=7;break}return e.next=6,this.throwError("Node with such id not found");case 6:return e.abrupt("return",e.sent);case 7:return e.next=9,this.processNode(n);case 9:return e.next=11,this.forwardProcess(n);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"processUnreachable",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=this.data,e.t0=regeneratorRuntime.keys(t.nodes);case 2:if((e.t1=e.t0()).done){e.next=12;break}if(n=e.t1.value,void 0!==(r=t.nodes[n]).outputData){e.next=10;break}return e.next=8,this.processNode(r);case 8:return e.next=10,this.forwardProcess(r);case 10:e.next=2;break;case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"process",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o,i,s=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.length>1&&void 0!==s[1]?s[1]:null,this.processStart()){e.next=3;break}return e.abrupt("return");case 3:if(this.validate(t)){e.next=5;break}return e.abrupt("return");case 5:for(this.data=this.copy(t),r=s.length,o=new Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=s[i];return this.args=o,e.next=10,this.processStartNode(n);case 10:return e.next=12,this.processUnreachable();case 12:return e.abrupt("return",this.processDone()?"success":"aborted");case 13:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),t}(),index={Engine:Engine,Recursion:Recursion,Component:Component$1,Control:Control,Connection:Connection,Emitter:Emitter,Input:Input,IO:IO,Node:Node,NodeEditor:NodeEditor,Output:Output,Socket:Socket};exports.Component=Component$1,exports.Connection=Connection,exports.Control=Control,exports.Emitter=Emitter,exports.Engine=Engine,exports.IO=IO,exports.Input=Input,exports.Node=Node,exports.NodeEditor=NodeEditor,exports.Output=Output,exports.Recursion=Recursion,exports.Socket=Socket,exports.default=index;
//# sourceMappingURL=/sm/0646c58ce7081814f53960f356856d1f1e2b9be1b3019a2fd00d2fe43abd9755.map